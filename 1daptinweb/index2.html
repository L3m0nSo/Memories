<!DOCTYPE html>
<html lang="en-EN">
<head><title>DadaDash</title>
    <meta charset=utf-8>
    <meta name=description content="OpenFaceAPI">
    <meta name=format-detection content="telephone=no">
    <meta name=msapplication-tap-highlight content=no>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>


    <meta name=viewport content="user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"></link>

    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.5/css/dataTables.dataTables.css"/>

    <script src="https://cdn.datatables.net/2.0.5/js/dataTables.js"></script>

</head>
<body class=container-main>
<div id=app>
    <div id="topbar">
        <marquee width="60%" direction="left" height="100px">
            This is a sample scrolling text that has scrolls texts to the left.
        </marquee>
    </div>
    <div id="sidebar" style="float: left">
        <div id="control">
            <h4 href="">Tables</h4>
        </div>
        <div id="tables">

        </div>
        <div id="control2">
            <h4 href="">Others</h4>
        </div>
        <div id="items">

        </div>
    </div>
    <div class="siderbardivider"></div>
    <div id="content-main" style="float: left">
        <div class="heading">
            <h1 id="tableName"></h1>
        </div>
        <div id="data" class="data">
        </div>
        <div id="actions" class="actions">
        </div>
    </div>
</div>
</body>
<script>

    const ApplicationState = {
        authentication: null,
        endpoint: "http://localhost:6336",
        tableMap: {},
        currentTable: null
    }

    jQuery(document).ready(function () {
        console.log("jquery document ready");
        jQuery.ajax({
            url: ApplicationState.endpoint + "/api/action?page[size]=500",
            type: "GET",
            success: function (actionResponse) {
                console.log("actions", actionResponse);
                ApplicationState.Actions = actionResponse.data;
                loadSelfUserAccount();
                loadWorld();

            },
            error: function (err) {
                console.log("Failed to fetch actions", err)
            }
        })

        function loadSelfUserAccount() {
            jQuery.ajax({
                url: ApplicationState.endpoint + '/api/user_account/mine', // Set the URL of the API or server endpoint
                type: 'GET', // Specify the request type
                success: function (response) {
                    console.log('Data received:', response);
                },
                error: function (error) {
                    console.log('Error fetching data:', error);
                }
            });
        }

        function loadWorld() {
            jQuery.ajax({
                url: ApplicationState.endpoint + '/api/world?page[size]=200', // Set the URL of the API or server endpoint
                type: 'GET', // Specify the request type
                success: function (response) {
                    console.log('Data received:', response);
                    response.data.forEach(e => {
                        ApplicationState.tableMap[e.id] = e;
                    })
                    var items = response.data
                        .filter(e => {
                            console.log("is joint able: " + e.attributes.is_join_table)
                            return e.attributes.is_join_table === 0;
                        });
                    console.log("items: ", items)
                    items.sort((a, b) => a.attributes.table_name.localeCompare(b.attributes.table_name))
                    for (let i = 0; i < items.length; i++) {
                        $("<div id='" + items[i].id + "'>" +
                            "<a onclick=loadTable('" + items[i].id + "') href='#" + items[i].id + "'>" + toTitleCase(items[i].attributes.table_name) + "</a>" +
                            "</div>")
                            .appendTo("#tables")
                    }
                    if (items.length > 0) {
                        loadTable(items[0].id);
                    } else {

                    }
                },
                error: function (error) {
                    console.error('Error fetching data:', error);
                }
            });
        }

    })


    function loadTable(tableId) {
        var table = ApplicationState.tableMap[tableId];
        var tableSchema = JSON.parse(table.attributes.world_schema_json);
        ApplicationState.currentTable = tableSchema;
        let tableName = table.attributes.table_name;
        $("#tableName").text(toTitleCase(tableName))
        var columns = [];

        // var columnDefs = [];

        columns.push({
            title: "id",
            name: "id",
            data: 'id',
        });
        var columnDefs = [
            {
                target: 0,
                render: function (e) {
                    return "<a href='return' onclick='loadItem(\"" + e + "\")' >" + e + "</a>"
                }
            }
        ]

        $("#data").empty();
        $("#data").append("<table id='table'></table>")


        for (let i = 0; i < tableSchema.Columns.length; i++) {
            let column = tableSchema.Columns[i];
            if (column.IsForeignKey) {
                continue;
            }
            let columnName = column.Name;
            if (columnName === "version" ||
                columnName === "id" ||
                columnName === "reference_id" ||
                columnName === "permission" ||
                columnName === "updated_at" ||
                columnName === "created_at"
            ) {
                continue
            }
            var newColumnPosition = columns.length;
            if (column.ColumnType === "truefalse") {
                columns.push({
                    title: columnName,
                    name: columnName,
                    data: function (d) {
                        // console.log("Data for column", columnName, d.attributes[columnName])
                        if (d.attributes[columnName]) {
                            return "  <input disabled checked type=\"checkbox\" >"
                        } else {

                            return "  <input disabled type=\"checkbox\" >"
                        }
                    }
                })
            } else {
                columns.push({
                    title: columnName,
                    name: columnName,
                    data: 'attributes.' + columnName
                })
            }
        }

        columns.push({
            title: "created_at",
            name: "created_at",
            data: 'attributes.created_at'
        });

        columns.push({
            title: "updated_at",
            name: "updated_at",
            data: 'attributes.updated_at'
        });

        console.log("columns ", tableSchema, columns)
        let dataTable = $("#table").DataTable({
            serverSide: true,
            columns: columns,
            columnDefs: columnDefs,
            rowId: function (e) {
                // console.log("row id", e);
                return e.reference_id;
            },
            ajax: {
                url: ApplicationState.endpoint + '/api/' + tableName,
                data: function (xhrData) {
                    var transformedData = transformDataTablesRequest(xhrData);
                    // console.log("preXhr", xhrData, transformedData)
                    // xhrData["page[size]"] = xhrData.length;
                    // xhrData["page[number]"] = xhrData.start;
                    // for (var key in xhrData) {
                    //     delete xhrData[key]
                    // }
                    // for (var key in transformedData) {
                    //     xhrData[key] = transformedData[key]
                    // }
                    // console.log("modify datatable request", xhrData);
                    return transformedData;
                },
                dataFilter: function (data) {
                    // console.log("data filter", data);
                    var json = jQuery.parseJSON(data);
                    json.recordsTotal = json.links.total;
                    json.recordsFiltered = json.links.total;
                    return JSON.stringify(json); // return JSON string
                },
                dataSrc: 'data'
            }
        });


        var actions = ApplicationState.Actions.filter(e => {
            return e.attributes.world_id === table.id && e.attributes.instance_optional
        });


        $("#actions").empty();
        if (actions.length > 0) {
            $("<h2>Actions</h2>").appendTo("#actions")
            actions.forEach(e => {
                $("<div id='" + e.id + "'>" +
                    "<a onclick=loadAction('" + e.id + "') href='#" + e.id + "'>" + toTitleCase(e.attributes.action_name) + "</a>" +
                    "</div>")
                    .appendTo("#actions")

            })
        }

    }

    function toTitleCase(text) {
        return text
            .replace(/[-_]+/g, ' ')
            .replace(/([^\W_]+[^\s-]*)/g, function (txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
    }

    function transformDataTablesRequest(dataTablesRequest) {
        // Extract pagination info
        const pageNumber = dataTablesRequest.start / dataTablesRequest.length + 1;
        const pageSize = dataTablesRequest.length;

        // Extract global search value
        const globalFilter = dataTablesRequest.search.value;

        // Transform sort information
        let sort = dataTablesRequest.order.map(order => {
            const columnName = dataTablesRequest.columns[order.column].data;
            const direction = order.dir === 'asc' ? '' : '-';
            return `${direction}${columnName}`;
        }).join(',');

        // Transform search/filter conditions
        const query = [];
        dataTablesRequest.columns.forEach(column => {
            if (column.search.value !== "") {
                query.push({
                    column: column.data,
                    operator: 'eq',
                    value: column.search.value
                });
            } else if (column) {

            }
        });

        // Convert query object to JSON and then to base64
        const queryBase64 = btoa(JSON.stringify(query));

        // Example of how you might set grouping, sorting and included relations
        // const group = [{"column": "instance_optional", "order": "desc"}]; // Example static grouping
        const includedRelations = "user,post,author"; // Example static included relations

        // Construct the transformed request object
        return {
            'page[number]': pageNumber,
            'page[size]': pageSize,
            'query': queryBase64,
            'included_relations': includedRelations,
            'sort': sort,
            'filter': globalFilter
        };
    }

</script>
<style>

    .actions {
        position: absolute;
        bottom: 0;
        right: 0;
    }

    .data {
        float: left;
        margin: 5px;
    }

    html {
        font-family: monospace;
        /*height: 100vh;*/
        /*width: 100vw;*/
        /*overflow: hidden;*/
    }

    #sidebar {
        margin: 5px 5px 5px 5px;
        /*border-top: 3px solid black;*/
        height: calc(100vh - 70px);
        overflow: visible;
        /*border-bottom: 3px solid black;*/
    }

    .siderbardivider {
        border-right: 3px solid black;
        height: calc(100vh - 70px);
        float: left;
        cursor: ew-resize;
    }

    td {
        text-align: left;
        vertical-align: top;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
    }

    #tables div {
        margin: 5px;
    }

    .data {
        width: 50vw;
    }

    .heading {
        margin: 5px;
    }

    #topbar {
        height: 30px;
        background: black;
        color: white;
    }

</style>

</html>
